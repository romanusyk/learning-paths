---
title: "Obstacles to Learning English"
format:
  html:
    toc: false
    number-sections: false
    code-fold: true
    page-layout: full
---

This page analyzes responses to the survey question: *"Have you ever stopped learning English? If so, what were the main obstacles?"*

The free-text responses were analyzed and labeled by an LLM (Large Language Model) to identify common obstacle categories.

```{python}
import pandas as pd
import json
from collections import Counter, defaultdict
import matplotlib.pyplot as plt

df = pd.read_csv('../data/form_data.csv')
obs_df = pd.read_csv('../data/obstacles.csv')
with open('../data/obstacles_map.json', 'r', encoding='utf-8') as f:
    mapping = json.load(f)

# Build frequency of labels
label_counts = Counter()
for row in mapping:
    for label in row.get('labels', []):
        label_counts[label] += 1

total_with_answer = len({row['respondent_id'] for row in mapping})
count_never = label_counts.get('Never', 0)
count_stopped = total_with_answer - count_never
count_unknown = len(df) - total_with_answer

# Create pie chart for learning status distribution
labels = ['Stopped at least once', 'Never stopped', 'No data']
sizes = [count_stopped, count_never, count_unknown]
colors = ['#ff7f7f', '#90ee90', '#d3d3d3']

fig, ax = plt.subplots(figsize=(8, 6))
wedges, texts, autotexts = ax.pie(sizes, labels=labels, colors=colors, autopct='%1.0f%%', 
                                  startangle=90, textprops={'fontsize': 12})

# Make the percentage text bold
for autotext in autotexts:
    autotext.set_weight('bold')
    autotext.set_color('black')

ax.set_title('How many respondents have ever stopped learning?', fontsize=14, fontweight='bold', pad=20)

# Add legend with counts
legend_labels = [f'{label}: {size}' for label, size in zip(labels, sizes)]
ax.legend(wedges, legend_labels, loc="upper left", bbox_to_anchor=(1, 0, 0.5, 1))

plt.tight_layout()
plt.show()
```

### Obstacles by popularity

The chart below ranks obstacles by the number of respondents who mentioned them. Each obstacle category represents a cluster of similar responses identified by the LLM analysis.

```{python}
import matplotlib.pyplot as plt

# Exclude 'Never' from ranking of obstacles
obstacle_counts = {k: v for k, v in label_counts.items() if k != 'Never'}
ranked = sorted(obstacle_counts.items(), key=lambda kv: kv[1], reverse=True)

fig, ax = plt.subplots(figsize=(9, max(3, len(ranked)*0.4)))
ax.barh([k for k, _ in reversed(ranked)], [v for _, v in reversed(ranked)], color='#5B8FF9')
ax.set_xlabel('Number of respondents')
ax.set_title('How many respondents mentioned this obstacle?')
plt.tight_layout()
plt.show()
```

```{python}
# Display the ordered table with explanations (show full text, no truncation, no index column)
from IPython.display import display, HTML

explain_map = {r['obstacle']: r.get('explanation', '') for r in obs_df.to_dict(orient='records')}
rows = [
    {'obstacle': name, 'count': cnt, 'explanation': explain_map.get(name, '')}
    for name, cnt in ranked
]
table_df = pd.DataFrame(rows)

print("The table below shows each obstacle category with its frequency and a detailed explanation generated by the LLM based on the common themes found in respondent answers.")
print()

with pd.option_context('display.max_colwidth', None):
    html = table_df.to_html(index=False)
    display(HTML(html))
```

### Interactive: All examples with English translations

The table below lists every respondent's free-text obstacle answer alongside the set of mapped obstacles (labels). Use the buttons to filter by obstacle label and toggle between original and English text.

```{python}
#| echo: false
#| results: asis
import sys, os
from IPython.display import HTML, display
sys.path.append(os.path.abspath('..'))
from src.ui.data_tables.examples_table import render_examples_block

html_block = render_examples_block(
    table_id='obstacles-examples-table',
    form_csv='../data/form_data.csv',
    obstacles_eng_csv='../data/obstacles_eng.csv',
    map_json='../data/obstacles_map.json',
)
display(HTML(html_block))
```


